{% extends "base.html" %} 

{% block title %}
  Agenda de pendientes
{% endblock %}

{% block content %}

  {% include "./proyecto_form.html"%}
    
  <hr>

  <h2>Proyectos</h2>
  <section id="proyectos-wrapper"></section>

{% endblock %}

{% block style %}
  <style>
    h2{
      margin: 1rem 0;
    }
    
    #proyectos-wrapper{
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .proyectos-item{
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      border: 1px solid var(--disabled);
      border-left: 5px solid var(--primary);
      border-radius: 0rem 0.25rem 0.25rem 0rem;
    }
  </style>
{% endblock %}

{% block script %}
  <script>
    let proyectosArray = [];
    const $proyectos = document.querySelector('#proyectos-wrapper');
 
    const getProyectos = async() => {
      $proyectos.innerText = 'Loading...'
      try{
        const url = Flask.url_for('proyectos');
        let res = await fetch(url)
        let data = await res.json();
        proyectosArray = [...data];
        updateProyectos();
      }
      catch(err){
        $proyectos.innerText = err.error;
        console.error(err);
      }
    }

    const addProyecto = async({title, desc}) => {
      try{
        const url = Flask.url_for('proyectos');
        let res = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({title, desc})
        })
        let data = await res.json();
        proyectosArray = [...proyectosArray, data];
        updateProyectos();
      }
      catch(err){
        $proyectos.innerText = err.error;
        console.error(err);
      }
    }

    const deleteProyecto = async(id) => {
      try{
        const url = `${Flask.url_for('proyectos')}/${id}`;
        let res = await fetch(url, {
          method: "DELETE"
        })
        let data = await res.json();

        proyectosArray = [...proyectosArray.filter(proyecto => proyecto.id != data.id)];
        updateProyectos();
      }
      catch(err){
        console.error(err);
      }
    }

    const updateProyectos = () => {
      $proyectos.innerHTML = proyectosArray.length > 0 ? proyectosArray.map(proyecto => `
        <article class="proyectos-item">
          <div>
            <h3>${proyecto.title}</h4>
            <p>${proyecto.desc}</p>
          </div>
          <div>
            <button class='btn btn-warning' onClick="(deleteProyecto(${proyecto.id}))">Editar</button>
            <button class='btn btn-danger' onClick="(deleteProyecto(${proyecto.id}))">Eliminar</button>
          </div>
        </article>
      `).join('') : 'No hay proyectos aun.'
    }

    window.proyectos = {
      addProyecto,
      deleteProyecto
    }

    getProyectos();
  </script>
{% endblock %}